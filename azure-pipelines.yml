# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '12.x'
  displayName: 'Install Node.js'

- script: |
    yarn global add @angular/cli typescript
    yarn
    yarn build --prod
  displayName: 'yarn install and build'
  workingDirectory: search-tool

- task: DockerInstaller@0
  displayName: Docker Installer
  inputs:
    dockerVersion: 17.09.0-ce
    releaseType: stable

- script: |
    wget -O - https://github.com/openshift/source-to-image/releases/download/v1.2.0/source-to-image-v1.2.0-2a579ecd-linux-amd64.tar.gz | tar -xz
  displayName: Install Source-to-Image

- script: |
    ./s2i build . --context-dir search-tool/dist/search-tool ibotty/s2i-nginx docker.pkg.github.com/momothereal/wiki/search-tool:latest
    docker push docker.pkg.github.com/momothereal/wiki/search-tool:latest
  displayName: Build search-tool